<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.githrd.figurium.order.dao.OrderMapper">

    <insert id="insertOrders" parameterType="Map">
        insert into orders(id, user_id, payment_type, price, status, created_at, valid)
        values(
                null,
                1,
                #{ paymentType },
                #{ price },
                '준비중',
                CURRENT_TIMESTAMP,
                'y'
                )
    </insert>

    <select id="selectOneLast" resultType="orders">
        select * from orders order by id desc limit 1;
    </select>

    <select id="selectListByUserId" resultType="myOrders" parameterType="int">
        SELECT
            o.id AS order_id,
            o.user_id,
            o.payment_type,
            o.price,
            o.status,
            o.created_at,
            p.name AS product_name,
            p.image_url,
            (SELECT COUNT(*) - 1
             FROM order_items oi2
             WHERE oi2.order_id = o.id) AS remain_count
        FROM orders o
                 JOIN order_items oi ON o.id = oi.order_id
                 JOIN products p ON oi.product_id = p.id
        where o.user_id = #{userId}
        ORDER BY oi.id DESC
        LIMIT 1
    </select>

</mapper>












